{"version":3,"sources":["../src/download.js"],"names":["name","stdout","stderr","json","npmView","console","info","data","error","pkg","eval","j3Config","valid","run","npm_path","cwd","modules_path","err","npmInstall","undefined","log","__","cmd","args","options","resolve","reject","ls","on","str","toString"],"mappings":";;;;;;;;;;;;;;;AAoBA;;gDACO,WAAqBA,IAArB,EAA2BC,MAA3B,EAAmCC,MAAnC,EAA2C;AAC9C,YAAIC,OAAO,MAAMC,QAAQJ,IAAR,EAAc,gBAAQ;AACnCK,oBAAQC,IAAR,CAAaC,IAAb;AACH,SAFgB,EAEd,gBAAQ;AACPF,oBAAQG,KAAR,CAAcD,IAAd;AACH,SAJgB,CAAjB;AAKA,YAAIE,MAAMC,KAAK,MAAMP,IAAN,GAAa,GAAlB,CAAV;AACA,YAAI,CAACM,IAAIE,QAAT,EAAmB;AACf,mBAAO,KAAP;AACH;AACD,eAAO,IAAP;AACH,K;;oBAXqBC,K;;;;;AAatB;;;;gDA6BO,WAA0BZ,IAA1B,EAAgCC,MAAhC,EAAwCC,MAAxC,EAAgD;AACnD,YAAI;AACA,kBAAMW,IAAI,iBAAOC,QAAX,EAAqB,CAAC,SAAD,EAAYd,IAAZ,CAArB,EAAwC;AAC1Ce,qBAAK,iBAAOC;AAD8B,aAAxC,EAEHf,MAFG,EAEKC,MAFL,CAAN;AAGH,SAJD,CAIE,OAAOe,GAAP,EAAY;AACV,kBAAMA,GAAN;AACH;AACJ,K;;oBARqBC,U;;;;;;gDAUf,WAAuBlB,IAAvB,EAA6BC,MAA7B,EAAqCC,MAArC,EAA6C;AAChD,YAAI;AACA,mBAAO,MAAMW,IAAI,iBAAOC,QAAX,EAAqB,CAAC,MAAD,EAASd,IAAT,CAArB,EAAqCmB,SAArC,EAAgDlB,MAAhD,EAAwDC,MAAxD,CAAb;AACH,SAFD,CAEE,OAAOe,GAAP,EAAY;AACV,kBAAMA,GAAN;AACH;AACJ,K;;oBANqBb,O;;;;;AArEtB;;AAIA;;;;AACA;;;;;;AAEA;;+CACe,WAAgBJ,IAAhB,EAAsBC,MAAtB,EAA8BC,MAA9B,EAAsC;AACjD,YAAI,EAAC,MAAMU,MAAMZ,IAAN,EAAYC,MAAZ,EAAoBC,MAApB,CAAP,CAAJ,EAAwC;AACpCG,oBAAQe,GAAR,CAAY,eAAKC,EAAL,CAAQ,eAAR,CAAZ;AACA;AACH;AACD,cAAMH,WAAWlB,IAAX,EAAiBC,MAAjB,EAAyBC,MAAzB,CAAN;AACH,K;;;;;MAlBD;;;;AAmCA,SAASW,GAAT,CAAaS,GAAb,EAAkBC,IAAlB,EAAwBC,OAAxB,EAAiCvB,MAAjC,EAAyCC,MAAzC,EAAiD;AAC7C,WAAO,sBAAY,CAACuB,OAAD,EAAUC,MAAV,KAAqB;AACpC,YAAIC,KAAK,0BAAML,GAAN,EAAWC,IAAX,EAAiBC,OAAjB,CAAT;;AAEA,YAAIP,MAAM,EAAV;AAAA,YACIX,OAAO,EADX;AAEAqB,WAAG1B,MAAH,CAAU2B,EAAV,CAAa,MAAb,EAAqBrB,QAAQ;AACzB,gBAAIsB,MAAMtB,KAAKuB,QAAL,EAAV;AACAxB,oBAAQuB,GAAR;AACA5B,mBAAO4B,GAAP;AACH,SAJD;;AAMAF,WAAGzB,MAAH,CAAU0B,EAAV,CAAa,MAAb,EAAqBrB,QAAQ;AACzB,gBAAIsB,MAAMtB,KAAKuB,QAAL,EAAV;AACAb,mBAAOY,GAAP;AACA3B,mBAAO2B,GAAP;AACH,SAJD;;AAMAF,WAAGC,EAAH,CAAM,MAAN,EAAc,MAAM;AAChB,gBAAIX,GAAJ,EAAS;AACLS,uBAAOT,GAAP;AACH,aAFD,MAEO;AACHQ,wBAAQnB,IAAR;AACH;AACJ,SAND;AAOH,KAxBM,CAAP;AAyBH","file":"download.js","sourcesContent":["/*\r\n    用于模块文件及依赖自动下载，使用npm完成，吴丹妮\r\n*/\r\n\r\nimport {\r\n    spawn\r\n} from 'child_process'\r\n\r\nimport config from './config'\r\nimport lang from 'i18n'\r\n\r\n// 下载前进行验证，如果确实是j3模块，则下载\r\nexport default async function (name, stdout, stderr) {\r\n    if (!await valid(name, stdout, stderr)) {\r\n        console.log(lang.__('not_j3_module'))\r\n        return\r\n    }\r\n    await npmInstall(name, stdout, stderr)\r\n}\r\n\r\n// 验证模块是否符合需求\r\nexport async function valid(name, stdout, stderr) {\r\n    let json = await npmView(name, data => {\r\n        console.info(data)\r\n    }, data => {\r\n        console.error(data)\r\n    })\r\n    let pkg = eval('(' + json + ')')\r\n    if (!pkg.j3Config) {\r\n        return false\r\n    }\r\n    return true\r\n}\r\n\r\n// 执行一个进程，并提供输入及输出。\r\nfunction run(cmd, args, options, stdout, stderr) {\r\n    return new Promise((resolve, reject) => {\r\n        let ls = spawn(cmd, args, options)\r\n\r\n        let err = '',\r\n            info = ''\r\n        ls.stdout.on('data', data => {\r\n            let str = data.toString()\r\n            info += str\r\n            stdout(str)\r\n        })\r\n\r\n        ls.stderr.on('data', data => {\r\n            let str = data.toString()\r\n            err += str\r\n            stderr(str)\r\n        })\r\n\r\n        ls.on('exit', () => {\r\n            if (err) {\r\n                reject(err)\r\n            } else {\r\n                resolve(info)\r\n            }\r\n        })\r\n    })\r\n}\r\n\r\nexport async function npmInstall(name, stdout, stderr) {\r\n    try {\r\n        await run(config.npm_path, ['install', name], {\r\n            cwd: config.modules_path\r\n        }, stdout, stderr)\r\n    } catch (err) {\r\n        throw err\r\n    }\r\n}\r\n\r\nexport async function npmView(name, stdout, stderr) {\r\n    try {\r\n        return await run(config.npm_path, ['view', name], undefined, stdout, stderr)\r\n    } catch (err) {\r\n        throw err\r\n    }\r\n}\r\n"]}